# 结算流程设计

本项目**不追求 100% 和官方结算流程实现一致**。本项目的流程实现细节可能与官方行为有很大出入，底线是尽可能保证**符合官方规则说明的要求**。

建议阅读 [state](./state.md) 了解本项目对游戏状态的基本操作原语：mutations 和技能。

总而言之，`Game` 对对局状态的修改只包含这几类：
- 各游戏阶段的显然操作，如步进回合数、翻转行动轮次，以及玩家 IO 的结果；
- 使用主动技能；
- 技能执行或常规流程引发（emit）了事件，执行对这一事件的所有实体的响应技能。

每一次转移游戏阶段都会到达一个暂停点。

项目使用 `SkillExecutor` 类来结算技能。该类提供两个接口：
- `SkillExecutor.executeSkill` 结算技能；
- `SkillExecutor.handleEvent` 引发一个事件，并结算响应该事件的所有技能。

## 结算技能

此部分实现方案主要参考 [LL夜鹰](https://space.bilibili.com/4360502) 与 [Fried-Chicken](https://space.bilibili.com/442588088) 起草的 ["七圣规则集"](https://docs.qq.com/doc/DZHhJVm1FRERIdk9q)。注意，该规则行文尚有不严谨之处，故我在部分细节上自行采取了和本项目契合的算法。

详细说明建议查阅代码。以下为简要流程概述：
- 执行技能函数，获得其中引发的事件列表；
- 暂停点；
- 将事件列表中响应 `onDamageOrHeal` 的事件称为“伤害事件”，否则称为“非伤害事件”。按此划分为两个列表；
- 检查“伤害事件列表”中所有可能导致角色倒下的伤害：
  - 若该伤害的目标存在一个 `modifyZeroHealth` 的待响应实体，则：
    - 将这个伤害标记为“非致命的”；
    - 将目标角色保存到“需复苏列表”；
  - 否则：
    - 将此伤害标记为“致命的”；
    - 将角色标记为倒下，清空元素附着和充能；
- 将不会导致角色倒下的伤害标记为“非致命的”。
- 依据上述特性，再将伤害事件列表分为“致命伤害列表”和“非致命伤害列表”；
- 对“需复苏列表”中的每个角色，应用 `modifyZeroHealth`，治疗角色，引发 `onDamageOrHeal` 事件。
- 若技能是主动技能且产出充能，则产出充能；
- 暂停点；
- 引发并响应“非伤害事件列表”中的每个事件；
- 引发并响应“非致命伤害列表”中的每个事件；
- 引发并响应“致命伤害列表”中的每个事件。
- 检查双方出战角色是否标记为倒下。若是：
  - 要求玩家选择新的出战角色；
- 双方选择完毕后，切换出战角色。
- 暂停点；
- 引发当前轮次玩家的 `onSwitchActive`（若有），然后引发另一玩家的 `onSwitchActive`。

## 事件响应

- 记“待响应技能列表”为空列表；
- 若此事件是 `onDispose`，则将被弃置的实体响应 `onDispose` 事件的技能加入“待响应技能列表”中；
- 列出**当前**场上的所有实体。其中：
  - 包括标记为倒下的角色；倒下角色和倒下角色区上的实体会排列在所有其他实体之前；
  - 对于每个实体：将该实体所有包含响应此事件的技能加入“待响应技能列表”；
- 对于每一技能：
  - 若该技能并非来自 `onDispose` 自身，且不存在于最新对局状态：跳过此趟循环，继续检查下一实体；
  - 检查技能的 `filter`。若否，跳过此趟循环，继续检查下一技能；
  - 结算此技能。


